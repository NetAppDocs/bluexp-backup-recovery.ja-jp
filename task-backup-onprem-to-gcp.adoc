---
sidebar: sidebar 
permalink: task-backup-onprem-to-gcp.html 
keywords: backing up, back up, backup, backup on-prem ontap, on-premises, back up volumes, cloud backup, gcp, google cloud 
summary: いくつかの手順を実行して、オンプレミスのONTAP システムからGoogle Cloud Storageへのボリュームデータのバックアップを開始します。 
---
= オンプレミスの ONTAP データを Google Cloud Storage にバックアップする
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
いくつかの手順を実行して、オンプレミスのONTAP システムからGoogle Cloud Storageへのボリュームデータのバックアップを開始します。

「オンプレミス ONTAP システム」には、 FAS 、 AFF 、 ONTAP Select の各システムが含まれます。



== クイックスタート

これらの手順を実行すると、すぐに作業を開始できます。また、残りのセクションまでスクロールして詳細を確認することもできます。

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-1.png["1つ"] 構成がサポートされていることを確認します
[role="quick-margin-list"]
* オンプレミスクラスタを検出し、BlueXPの作業環境として追加しました。を参照してください https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html["ONTAP クラスタの検出"^] を参照してください。
+
** クラスタでONTAP 9.7P5以降が実行されている（ONTAP 9.8P13以降を推奨）。
** クラスタには SnapMirror ライセンスがあります。このライセンスは、 Premium Bundle または Data Protection Bundle に含まれています。
** クラスタから Google ストレージおよびコネクタへの必要なネットワーク接続が確立されている必要があります。


* コネクタに、 Google ストレージおよびクラスタへの必要なネットワーク接続がある。
* バックアップを格納するオブジェクトストレージスペース用の有効な Google サブスクリプションが必要です。
* ONTAP クラスタがデータをバックアップおよびリストアできるように、アクセスキーとシークレットキーを持つ Google アカウントを用意しておきます。


.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-2.png["2 つ"] システムでBlueXPのバックアップとリカバリを有効にします
[role="quick-margin-para"]
作業環境を選択し、右パネルのバックアップ/リカバリサービスの横にある*Enable>Backup Volumes]をクリックして、セットアップ・ウィザードに従います。

[role="quick-margin-para"]
image:screenshot_backup_onprem_enable.png["作業環境を選択した後に使用できる[バックアップとリカバリの有効化]ボタンを示すスクリーンショット。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-3.png["3つ"] クラウドプロバイダを選択し、プロバイダの詳細を入力します
[role="quick-margin-para"]
プロバイダとして Google Cloud を選択し、プロバイダの詳細を入力します。ボリュームが配置されているONTAP クラスタのIPspaceを指定する必要があります。また、Googleが管理するデフォルトの暗号化キーを使用する代わりに、お客様が管理する独自のキーを選択してデータを暗号化することもできます。

[role="quick-margin-para"]
image:screenshot_backup_onprem_to_google.png["オンプレミスのONTAP システムからGoogle Cloud Storageバケットにボリュームをバックアップする際のクラウドプロバイダの詳細を示すスクリーンショット。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-4.png["4."] デフォルトのバックアップポリシーを定義
[role="quick-margin-para"]
デフォルトポリシーでは、毎日ボリュームがバックアップされ、各ボリュームの最新の 30 個のバックアップコピーが保持されます。毎時、毎日、毎週、毎月、または毎年のバックアップに変更します。 または、オプションを追加するシステム定義のポリシーを1つ選択します。保持するバックアップコピーの数を変更することもできます。

[role="quick-margin-para"]
バックアップはデフォルトでStandardストレージに格納されます。クラスタでONTAP 9.12.1以降を使用している場合は、特定の日数が経過した後にGoogleアーカイブストレージにバックアップを階層化して、コストをさらに最適化することができます。 link:concept-cloud-backup-policies.html["使用可能なBlueXPのバックアップとリカバリポリシーの設定の詳細については、こちらをご覧ください"^]。

[role="quick-margin-para"]
image:screenshot_backup_policy_gcp.png["BlueXPのバックアップとリカバリの設定を示すスクリーンショットで、バックアップスケジュールと保持期間を選択できます。"]

.image:https://raw.githubusercontent.com/NetAppDocs/common/main/media/number-5.png["5 つ"] バックアップするボリュームを選択します
[role="quick-margin-para"]
Select Volumes （ボリュームの選択）ページで、デフォルトのバックアップポリシーを使用してバックアップするボリュームを特定します。特定のボリュームに異なるバックアップポリシーを割り当てる場合は、あとから追加のポリシーを作成してボリュームに適用できます。



== 要件

オンプレミスボリュームを Google Cloud ストレージにバックアップする前に、次の要件を確認し、サポートされている構成であることを確認してください。

オンプレミスの ONTAP システムから Google Cloud Storage へのバックアップを設定する際に使用できる接続方法は 2 つあります。

* パブリック接続 - パブリック Google エンドポイントを使用して、 ONTAP システムを Google Cloud Storage に直接接続します。
* プライベート接続- VPNまたはGoogle Cloud Interconnectを使用して、プライベートIPアドレスを使用するプライベートGoogle Accessインターフェイス経由でトラフィックをルーティングします。


次の図は、*パブリック接続*メソッドと、コンポーネント間の準備に必要な接続を示しています。コネクターはGoogle Cloud Platform VPCに展開する必要があります。

image:diagram_cloud_backup_onprem_gcp_public.png["BlueXPのバックアップとリカバリが、クラスタ上のボリュームおよびバックアップファイルが配置されているGoogle Cloudストレージとのパブリック接続を介してどのように通信するかを示す図。"]

次の図は、*プライベート接続*メソッドと、コンポーネント間の準備に必要な接続を示しています。コネクターはGoogle Cloud Platform VPCに展開する必要があります。

image:diagram_cloud_backup_onprem_gcp_private.png["BlueXPのバックアップとリカバリが、クラスタ上のボリュームおよびバックアップファイルが配置されているGoogle Cloudストレージとのプライベート接続を介して通信する仕組みを示す図。"]



=== ONTAP クラスタの準備

ボリュームデータのバックアップを開始する前に、BlueXPでオンプレミスONTAP クラスタを検出する必要があります。

https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html["クラスタの検出方法について説明します"^]。

ONTAP の要件::
+
--
* ONTAP 9.7P5以降を使用することを推奨します。ONTAP 9.8P13以降を使用することを推奨します。
* SnapMirror ライセンス（ Premium Bundle または Data Protection Bundle に含まれます）。
+
*注：* BlueXPのバックアップとリカバリを使用する場合、「Hybrid Cloud Bundle」は必要ありません。

+
方法を参照してください https://docs.netapp.com/us-en/ontap/system-admin/manage-licenses-concept.html["クラスタライセンスを管理します"^]。

* 時間とタイムゾーンが正しく設定されている。
+
方法を参照してください https://docs.netapp.com/us-en/ontap/system-admin/manage-cluster-time-concept.html["クラスタ時間を設定します"^]。



--
クラスタネットワークの要件::
+
--
* ONTAP クラスタは、クラスタ間 LIF から Google Cloud ストレージへのバックアップおよびリストア処理用に、ポート 443 経由で HTTPS 接続を開始します。
+
ONTAP は、オブジェクトストレージとの間でデータの読み取りと書き込みを行います。オブジェクトストレージが開始されることはなく、応答するだけです。

* ONTAP では、コネクタからクラスタ管理 LIF へのインバウンド接続が必要です。このコネクタは、 Google Cloud Platform VPC 内に配置できます。
* クラスタ間 LIF は、バックアップ対象のボリュームをホストする各 ONTAP ノードに必要です。LIF は、 ONTAP がオブジェクトストレージへの接続に使用する IPspace に関連付けられている必要があります。 https://docs.netapp.com/us-en/ontap/networking/standard_properties_of_ipspaces.html["IPspace の詳細については、こちらをご覧ください"^]。
+
BlueXPのバックアップとリカバリをセットアップするときに、使用するIPspaceを指定するように求められます。各 LIF を関連付ける IPspace を選択する必要があります。これは、「デフォルト」の IPspace または作成したカスタム IPspace です。

* ノードのクラスタ間 LIF からオブジェクトストアにアクセスできます。
* ボリュームが配置されている Storage VM に DNS サーバが設定されている。方法を参照してください https://docs.netapp.com/us-en/ontap/networking/configure_dns_services_auto.html["SVM 用に DNS サービスを設定"^]。
+
Private Google AccessまたはPrivate Service Connectを使用している場合は、DNSサーバーがポイントするように設定されていることを確認します `storage.googleapis.com` を正しい内部（プライベート）IPアドレスに割り当てます。

* をデフォルトとは異なる IPspace を使用している場合は、オブジェクトストレージへのアクセスを取得するために静的ルートの作成が必要になることがあります。
* 必要に応じてファイアウォールルールを更新して、ONTAP からオブジェクトストレージへのBlueXPのバックアップ/リカバリ接続（ポート443を経由）と、Storage VMからDNSサーバへのポート53（TCP / UDP）経由の名前解決トラフィックを許可します。


--




=== コネクタの作成または切り替え

Google Cloud Platform VPCにコネクタがすでに導入されている場合は、すべて設定されます。ない場合は、ONTAP データをGoogle Cloudストレージにバックアップするために、その場所にコネクタを作成する必要があります。別のクラウドプロバイダやオンプレミスに導入されているコネクタは使用できません。

* https://docs.netapp.com/us-en/cloud-manager-setup-admin/concept-connectors.html["コネクタについて説明します"^]
* https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-quick-start-connector-google.html["コネクタをGCPにインストールする"^]




=== コネクタのネットワークを準備しています

コネクタに必要なネットワーク接続があることを確認します。

.手順
. コネクタが取り付けられているネットワークで次の接続が有効になっていることを確認します。
+
** ポート443を介してBlueXPバックアップおよびリカバリサービスとGoogle CloudストレージへのHTTPS接続 (https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-set-up-networking-google.html#endpoints-contacted-for-day-to-day-operations["エンドポイントのリストを参照してください"^])
** ONTAP クラスタ管理 LIF へのポート 443 経由の HTTPS 接続


. Connectorを展開するサブネットでプライベートGoogleアクセス（またはプライベートサービス接続）を有効にします。 https://cloud.google.com/vpc/docs/configure-private-google-access["プライベート Google アクセス"^] または https://cloud.google.com/vpc/docs/configure-private-service-connect-apis#on-premises["Private Service Connectの略"^] ONTAP クラスタからVPCへの直接接続が確立されていて、ConnectorとGoogle Cloud Storage間の通信を仮想プライベートネットワーク（*プライベート*接続）のままにする場合に必要です。
+
Googleの指示に従って、プライベートアクセスオプションを設定します。DNSサーバが参照するように設定されていることを確認します `www.googleapis.com` および `storage.googleapis.com` を正しい内部（プライベート）IPアドレスに割り当てます。





=== コネクタの権限を確認または追加します

BlueXPのバックアップとリカバリの「Search & Restore」機能を使用するには、コネクタがGoogle Cloud BigQueryサービスにアクセスできるように、コネクタのロールに特定の権限が必要です。以下の権限を確認し、ポリシーを変更する必要がある場合は手順に従います。

.手順
. を参照してください https://console.cloud.google.com["Google Cloud Console の略"^]をクリックし、 * Roles * ページに移動します。
. ページ上部のドロップダウンリストを使用して、編集するロールを含むプロジェクトまたは組織を選択します。
. カスタムロールをクリックします。
. 役割の権限を更新するには、 * 役割の編集 * をクリックします。
. [ 権限の追加 *] をクリックして、次の新しい権限を役割に追加します。
+
[source, json]
----
bigquery.jobs.get
bigquery.jobs.list
bigquery.jobs.listAll
bigquery.datasets.create
bigquery.datasets.get
bigquery.jobs.create
bigquery.tables.get
bigquery.tables.getData
bigquery.tables.list
bigquery.tables.create
----
. [ 更新（ Update ） ] をクリックして、編集したロールを保存する。




=== Google Cloud Storage でバックアップを準備しています

バックアップを設定するときは、特定の権限を持つサービスアカウントのストレージアクセスキーを指定する必要があります。サービスアカウントを使用すると、BlueXPのバックアップとリカバリで、バックアップの格納に使用されるCloud Storageバケットを認証してアクセスできます。キーは、 Google Cloud Storage がリクエストを発行しているユーザーを認識できるようにするために必要です。

.手順
. を参照してください https://console.cloud.google.com["Google Cloud Console の略"^]をクリックし、 * Roles * ページに移動します。
. https://cloud.google.com/iam/docs/creating-custom-roles#creating_a_custom_role["新しいロールを作成します"^] 次の権限が必要です。
+
[source, json]
----
storage.buckets.create
storage.buckets.delete
storage.buckets.get
storage.buckets.list
storage.buckets.update
storage.buckets.getIamPolicy
storage.multipartUploads.create
storage.objects.create
storage.objects.delete
storage.objects.get
storage.objects.list
storage.objects.update
----
. Google Cloud コンソールで、 https://console.cloud.google.com/iam-admin/serviceaccounts["[ サービスアカウント ] ページに移動します"^]。
. クラウドプロジェクトを選択します。
. ［*サービスアカウントの作成*］をクリックして、必要な情報を入力します。
+
.. * サービスアカウントの詳細 * ：名前と説明を入力します。
.. *このサービスアカウントにプロジェクトへのアクセス権を付与*:作成したカスタムロールを選択します。
.. [ 完了（ Done ） ] をクリックします。


. に進みます https://console.cloud.google.com/storage/settings["GCP Storage Settings （ GCP ストレージ設定）"^] サービスアカウントのアクセスキーを作成します。
+
.. プロジェクトを選択し、 * 互換性 * をクリックします。まだ有効にしていない場合は、 * 相互運用アクセスを有効にする * をクリックします。
.. [ サービスアカウントのアクセスキー *] で、 [ サービスアカウントのキーの作成 *] をクリックし、作成したサービスアカウントを選択して、 [ キーの作成 *] をクリックします。
+
あとでバックアップサービスを設定するときに、BlueXPのバックアップとリカバリでキーを入力する必要があります。







==== 顧客管理暗号化キー（CMEK）の使用

Googleが管理するデフォルトの暗号化キーを使用する代わりに、お客様が管理する独自のキーを使用してデータを暗号化できます。クロスリージョンキーとクロスプロジェクトキーの両方がサポートされているため、CMEKキーのプロジェクトとは異なるバケット用のプロジェクトを選択できます。お客様が管理する独自のキーを使用する場合は、次の手順を実行します。

* アクティベーションウィザードでこの情報を追加できるように、キーリングとキー名が必要です。 https://cloud.google.com/kms/docs/cmek["お客様が管理する暗号化キーの詳細については、こちらをご覧ください"^]。
* これらの必要な権限がコネクタの役割に含まれていることを確認する必要があります。
+
[source, json]
----
cloudkms.cryptoKeys.get
cloudkms.cryptoKeys.getIamPolicy
cloudkms.cryptoKeys.list
cloudkms.cryptoKeys.setIamPolicy
cloudkms.keyRings.get
cloudkms.keyRings.getIamPolicy
cloudkms.keyRings.list
cloudkms.keyRings.setIamPolicy
----
* プロジェクトでGoogleの「Cloud Key Management Service（KMS）」APIが有効になっていることを確認する必要があります。を参照してください https://cloud.google.com/apis/docs/getting-started#enabling_apis["Google Cloudドキュメント：APIの有効化"] を参照してください。


* CMEKの考慮事項：*

* HSM（ハードウェアバックアップ）キーとソフトウェア生成キーの両方がサポートされています。
* 新しく作成またはインポートしたCloud KMSキーは両方サポートされます。
* リージョンキーのみがサポートされています。グローバルキーはサポートされていません。
* 現在、「対称暗号化/復号化」の目的のみがサポートされています。
* BlueXPのバックアップとリカバリによって、ストレージアカウントに関連付けられたサービスエージェントには、「CryptoKey encrypter/Decrypter（roles/cloudkms.cryptoKeyEncrypterDecrypter）」IAMロールが割り当てられます。




=== ライセンス要件を確認

* クラスタでBlueXPのバックアップとリカバリをアクティブ化するには、Googleから従量課金制（PAYGO）のBlueXP Marketplaceサービスに登録するか、ネットアップからBlueXPバックアップとリカバリのBYOLライセンスを購入してアクティブ化する必要があります。これらのライセンスはアカウント用であり、複数のシステムで使用できます。
+
** BlueXPのバックアップとリカバリのPAYGOライセンスを購入するには、のサブスクリプションが必要です https://console.cloud.google.com/marketplace/details/netapp-cloudmanager/cloud-manager?supportedpurview=project["Google Marketplaceで提供されているNetApp BlueXPサービス"^]。BlueXPのバックアップとリカバリの課金は、このサブスクリプションを通じて行われます。
** BlueXPのバックアップとリカバリのBYOLライセンスの場合は、ライセンスの期間と容量にわたってサービスを使用できるネットアップのシリアル番号が必要です。 link:task-licensing-cloud-backup.html#use-a-bluexp-backup-and-recovery-byol-license["BYOL ライセンスの管理方法について説明します"]。


* バックアップを格納するオブジェクトストレージスペース用の Google サブスクリプションが必要です。
+
すべての地域で、オンプレミスシステムからGoogle Cloud Storageへのバックアップを作成できます https://cloud.netapp.com/cloud-volumes-global-regions["Cloud Volumes ONTAP がサポートされている場合"^]。サービスのセットアップ時にバックアップを保存するリージョンを指定します。





== BlueXPのバックアップとリカバリを有効にする

BlueXPのバックアップとリカバリは、オンプレミスの作業環境からいつでも直接実行できます。

.手順
. キャンバスから作業環境を選択し、右パネルのバックアップとリカバリサービスの横にある*Enable>Backup Volumes]をクリックします。
+
バックアップ先のGoogle Cloud StorageがCanvas上の作業環境として存在する場合は、クラスタをGoogle Cloud Storage作業環境にドラッグしてセットアップウィザードを開始できます。

+
image:screenshot_backup_onprem_enable.png["作業環境を選択した後に使用できる[バックアップとリカバリの有効化]ボタンを示すスクリーンショット。"]

. プロバイダとして Google Cloud を選択し、 * 次へ * をクリックします。
. プロバイダの詳細を入力し、 * 次へ * をクリックします。
+
.. バックアップ用に Google Cloud Storage バケットを作成する Google Cloud Project 。（プロジェクトには、特定の権限を持つカスタムロールを持つサービスアカウントが必要です- <<Google Cloud Storage でバックアップを準備しています,ここで説明するようにします>>. ）
.. バックアップの保存に使用する Google Access Key および Secret Key 。
.. バックアップが保存される Google リージョン。
.. バックアップするボリュームが配置されている ONTAP クラスタ内の IPspace 。この IPspace のクラスタ間 LIF には、アウトバウンドのインターネットアクセスが必要です。
.. Googleが管理するデフォルトの暗号化キーを使用する場合でも、お客様が管理する独自のキーを選択してデータの暗号化を管理する場合でも、CMEKを使用するには、キーリングとキー名が必要です。 https://cloud.google.com/kms/docs/cmek["お客様が管理する暗号化キーの詳細については、こちらをご覧ください"^]。
+
image:screenshot_backup_onprem_to_google.png["オンプレミスのクラスタから Google Cloud Storage にボリュームをバックアップする際のクラウドプロバイダの詳細を示すスクリーンショット。"]



. アカウントのBlueXPバックアップ/リカバリライセンスがない場合は、この時点で、使用する課金方法を選択するように求められます。Googleから従量課金制（PAYGO）のBlueXP Marketplaceサービスにサブスクライブするか（複数のサブスクリプションがある場合は1つ選択する必要があります）、ネットアップからBlueXPバックアップ/リカバリBYOLライセンスを購入してアクティブ化できます。 link:task-licensing-cloud-backup.html["BlueXPのバックアップ/リカバリライセンスのセットアップ方法をご紹介します。"]
. デフォルト・ポリシーに使用するバックアップ・ポリシーの詳細を入力し、［*次へ*］をクリックします。既存のポリシーを選択するか、各セクションで選択した内容を入力して新しいポリシーを作成できます。
+
.. デフォルトポリシーの名前を入力します。名前を変更する必要はありません。
.. バックアップスケジュールを定義し、保持するバックアップの数を選択します。 link:concept-ontap-backup-to-cloud.html#customizable-backup-schedule-and-retention-settings["選択可能な既存のポリシーのリストが表示されます"^]。
.. ONTAP 9.12.1以降を使用している場合は、特定の日数を経過したバックアップをアーカイブストレージに階層化して、さらにコストを最適化することができます。 link:concept-cloud-backup-policies.html["使用可能なBlueXPのバックアップとリカバリポリシーの設定の詳細については、こちらをご覧ください"^]。
+
image:screenshot_backup_policy_gcp.png["BlueXPのバックアップとリカバリの設定を示すスクリーンショットで、バックアップスケジュールと保持期間を選択できます。"]



. Select Volumes（ボリュームの選択）ページで、定義済みのバックアップポリシーを使用してバックアップするボリュームを選択します。特定のボリュームに異なるバックアップポリシーを割り当てる場合は、追加のポリシーを作成し、それらのボリュームにあとから適用できます。
+
** すべての既存ボリュームと今後追加されるすべてのボリュームをバックアップするには、[既存および将来のすべてのボリュームをバックアップ...]チェックボックスをオンにします。このオプションは、すべてのボリュームをバックアップし、新しいボリュームのバックアップを有効にする必要がないようにすることを推奨します。
** 既存のボリュームのみをバックアップする場合は、タイトル行（image:button_backup_all_volumes.png[""]）。
** 個々のボリュームをバックアップするには、各ボリュームのボックス（image:button_backup_1_volume.png[""]）。
+
image:screenshot_backup_select_volumes.png["バックアップするボリュームを選択するスクリーンショット。"]

** この作業環境に、この作業環境用に選択したバックアップスケジュールラベル（日次、週次など）に一致する読み取り/書き込みボリュームのローカルSnapshotコピーがある場合は、「Export existing Snapshot copies to object storage as backup copies」というプロンプトが追加で表示されます。ボリュームを完全に保護するために、履歴Snapshotをすべてバックアップファイルとしてオブジェクトストレージにコピーする場合は、このチェックボックスをオンにします。


. [バックアップをアクティブ化]*をクリックすると、BlueXPのバックアップとリカバリによってボリュームの初期バックアップの作成が開始されます。


.結果
Google Cloud Storageバケットは、入力したGoogleアクセスキーとシークレットキーで指定されたサービスアカウントに自動的に作成され、そこにバックアップファイルが格納されます。ボリュームバックアップダッシュボードが表示され、バックアップの状態を監視できます。を使用して、バックアップジョブとリストアジョブのステータスを監視することもできます link:task-monitor-backup-jobs.html["［ジョブ監視］パネル"^]。



== 次の手順

* 可能です link:task-manage-backups-ontap.html["バックアップファイルとバックアップポリシーを管理"^]。バックアップの開始と停止、バックアップの削除、バックアップスケジュールの追加と変更などが含まれます。
* 可能です link:task-manage-backup-settings-ontap.html["クラスタレベルのバックアップの設定を管理します"^]。これには、クラウドストレージへのアクセスにONTAP で使用するストレージキーの変更、オブジェクトストレージへのバックアップのアップロードに使用できるネットワーク帯域幅の変更、将来のボリュームに対する自動バックアップ設定の変更などが含まれます。
* また可能です link:task-restore-backups-ontap.html["ボリューム、フォルダ、または個々のファイルをバックアップファイルからリストアする"^] Google の Cloud Volumes ONTAP システムやオンプレミスの ONTAP システムに接続できます。

